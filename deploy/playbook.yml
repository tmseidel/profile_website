---
# Ansible Playbook: Deploy profile_website
# Usage:
#   1. Copy deploy/.env.example to deploy/.env and fill in your values
#   2. Run:  ./deploy.sh
#   3. Content-only deploy:  ./deploy.sh content
#
# Manual usage (without deploy.sh):
#   ansible-playbook -i inventory.ini playbook.yml \
#     -e "server_name=yourdomain.com certbot_email=you@example.com"

- name: Deploy profile_website
  hosts: webservers
  become: true

  vars:
    # Directory on the control node where the built site lives after `npm run build`
    local_dist_dir: "{{ playbook_dir }}/../dist"
    # Web root on the target server
    web_root: /var/www/profile_website
    # Nginx server name (override via --extra-vars)
    server_name: "{{ ansible_host }}"
    # Email for Let's Encrypt (override via --extra-vars)
    certbot_email: ""
    # Nginx site config name
    nginx_site_name: profile_website

  pre_tasks:
    - name: Ensure dist/ directory exists locally
      delegate_to: localhost
      become: false
      stat:
        path: "{{ local_dist_dir }}"
      register: dist_stat

    - name: Fail if dist/ does not exist â€“ run 'npm run build' first
      fail:
        msg: >
          The dist/ directory was not found at {{ local_dist_dir }}.
          Please build the site first: npm run build
      when: not dist_stat.stat.exists

    - name: Fail if certbot_email is not set
      fail:
        msg: >
          certbot_email is required for Let's Encrypt. Pass it via:
          -e "certbot_email=you@example.com"
      when: certbot_email == ""
      tags: [setup, certbot]

  tasks:
    # ----------------------------------------------------------------
    # 1. Install dependencies
    # ----------------------------------------------------------------
    - name: Install nginx
      ansible.builtin.package:
        name: nginx
        state: present
      tags: [setup, nginx]

    - name: Install certbot and nginx plugin
      ansible.builtin.package:
        name:
          - certbot
          - python3-certbot-nginx
        state: present
      tags: [setup, certbot]

    # ----------------------------------------------------------------
    # 2. Create web root directory
    # ----------------------------------------------------------------
    - name: Create web root directory
      ansible.builtin.file:
        path: "{{ web_root }}"
        state: directory
        owner: www-data
        group: www-data
        mode: "0755"
      tags: [setup, content]

    # ----------------------------------------------------------------
    # 3. Synchronise built website files
    # ----------------------------------------------------------------
    - name: Sync website files to web root
      ansible.posix.synchronize:
        src: "{{ local_dist_dir }}/"
        dest: "{{ web_root }}/"
        delete: true
        recursive: true
        rsync_opts:
          - "--exclude=.DS_Store"
      notify: Reload nginx
      tags: [content]

    - name: Set correct ownership on web root
      ansible.builtin.file:
        path: "{{ web_root }}"
        owner: www-data
        group: www-data
        recurse: true
      tags: [content]

    # ----------------------------------------------------------------
    # 4. Configure nginx (initial HTTP-only for Certbot challenge)
    # ----------------------------------------------------------------
    - name: Write nginx site configuration
      ansible.builtin.template:
        src: templates/nginx_site.conf.j2
        dest: "/etc/nginx/sites-available/{{ nginx_site_name }}"
        owner: root
        group: root
        mode: "0644"
      notify: Reload nginx
      tags: [setup, nginx]

    - name: Enable nginx site
      ansible.builtin.file:
        src: "/etc/nginx/sites-available/{{ nginx_site_name }}"
        dest: "/etc/nginx/sites-enabled/{{ nginx_site_name }}"
        state: link
      notify: Reload nginx
      tags: [setup, nginx]

    - name: Disable default nginx site
      ansible.builtin.file:
        path: /etc/nginx/sites-enabled/default
        state: absent
      notify: Reload nginx
      tags: [setup, nginx]

    # ----------------------------------------------------------------
    # 5. Ensure nginx is running
    # ----------------------------------------------------------------
    - name: Ensure nginx is started and enabled
      ansible.builtin.service:
        name: nginx
        state: started
        enabled: true
      tags: [setup, nginx]

    # Flush handlers so nginx is reloaded before certbot runs
    - name: Flush handlers
      ansible.builtin.meta: flush_handlers
      tags: [setup, certbot]

    # ----------------------------------------------------------------
    # 6. Obtain SSL certificate with Certbot
    # ----------------------------------------------------------------
    - name: Check if SSL certificate already exists
      ansible.builtin.stat:
        path: "/etc/letsencrypt/live/{{ server_name }}/fullchain.pem"
      register: cert_stat
      tags: [setup, certbot]

    - name: Obtain Let's Encrypt certificate with Certbot
      ansible.builtin.command:
        cmd: >
          certbot --nginx
          --non-interactive
          --agree-tos
          --email {{ certbot_email }}
          --domains {{ server_name }}
          --redirect
      when: not cert_stat.stat.exists
      notify: Reload nginx
      tags: [setup, certbot]

    # ----------------------------------------------------------------
    # 7. Certbot auto-renewal
    # ----------------------------------------------------------------
    - name: Ensure certbot renewal timer is enabled
      ansible.builtin.systemd:
        name: certbot.timer
        state: started
        enabled: true
      tags: [setup, certbot]

  handlers:
    - name: Reload nginx
      ansible.builtin.service:
        name: nginx
        state: reloaded
